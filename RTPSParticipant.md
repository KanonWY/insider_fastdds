## RTPSParticipant

## 概述

采用 pImp 模式，实现都隐藏在 `RTPSParticipantImpl` 中。

```c++
class RTPSParticipant
{

protected:
    //!Pointer to the implementation.
    RTPSParticipantImpl* mp_impl;
};
```

#### 发现模式

```c++
struct ParticipantType
{
    static constexpr const char* SIMPLE = "SIMPLE";
    static constexpr const char* SERVER = "SERVER";
    static constexpr const char* CLIENT = "CLIENT";
    static constexpr const char* SUPER_CLIENT = "SUPER_CLIENT";
    static constexpr const char* BACKUP = "BACKUP";
    static constexpr const char* NONE = "NONE";
    static constexpr const char* EXTERNAL = "EXTERNAL";
    static constexpr const char* UNKNOWN = "UNKNOWN";
};

// 发现协议
typedef enum DiscoveryProtocol
{
    NONE,
    SIMPLE,
    EXTERNAL,
    CLIENT,
    SERVER, 
    BACKUP, 
    SUPER_CLIENT 

} DiscoveryProtocol_t;
```

域参与者属性

```c++
class RTPSParticipantAttributes
{
		LocatorList_t defaultUnicastLocatorList;
    LocatorList_t defaultMulticastLocatorList;
		fastdds::rtps::ExternalLocators default_external_unicast_locators;
    // 内部参数
    BuiltinAttributes builtin;
		// 端口参数
    PortParameters port;
		// 用户数据
    std::vector<octet> userData;
		// 参与者 ID
    int32_t participantID = -1;
  	// 流量控制
  	ThroughputControllerDescriptor throughputController;
  	// 用户定义传输层
    std::vector<std::shared_ptr<fastdds::rtps::TransportDescriptorInterface>> userTransports;
  	// 使用内建传输层
 		bool useBuiltinTransports = true;
  
      //! Flow controllers.
    FlowControllerDescriptorList flow_controllers;

    //! Thread settings for the builtin flow controllers sender threads
    fastdds::rtps::ThreadSettings builtin_controllers_sender_thread;

    //! Thread settings for the timed events thread
    fastdds::rtps::ThreadSettings timed_events_thread;

    //! Thread settings for the discovery server thread
    fastdds::rtps::ThreadSettings discovery_server_thread;

    //! Thread settings for the builtin transports reception threads
    fastdds::rtps::ThreadSettings builtin_transports_reception_threads;
};
```

#### RTPS参与者外部接口

它是一个域参与者基础类，可以被构建，内部实际实现在 RTPSParticipantImpl 中
```c++
class RTPSParticipant {

private:
    RTPSParticaipantImpl* mp_impl;
};
```


#### TRPS参与者实现
```c++
class RTPSParticipantImpl {
    //域名 ID
    uint32_t domain_id_;
    // RTPS 域参与者属性
    RTPSParticipantAttributes m_att;
    uint32_t metatraffic_unicast_port_ = 0;
    GUID_t m_guid;
    std::string guid_str_;
    GUID_t m_persistence_guid;
    //! Sending resources. - DEPRECATED -Stays commented for reference purposes
    // ResourceSend* mp_send_thr;
    //! Event Resource
    ResourceEvent mp_event_thr;
    //! BuiltinProtocols of this RTPSParticipant
    BuiltinProtocols* mp_builtinProtocols;
    //!Id counter to correctly assign the ids to writers and readers.
    std::atomic<uint32_t> IdCounter;
    //! Mutex to safely access endpoints collections
    mutable shared_mutex endpoints_list_mutex;
    //!Writer List.
    std::vector<RTPSWriter*> m_allWriterList;
    //!Reader List
    std::vector<RTPSReader*> m_allReaderList;
    //!Listen thread list.
    //!Writer List.
    std::vector<RTPSWriter*> m_userWriterList;
    //!Reader List
    std::vector<RTPSReader*> m_userReaderList;
    //!Network Factory
    NetworkFactory m_network_Factory;
    //! Type cheking function
    std::function<bool(const std::string&)> type_check_fn_;
    //!Pool of send buffers
    std::unique_ptr<SendBuffersManager> send_buffers_;

    bool client_override_;

    //! Autogenerated metatraffic locators flag
    bool internal_metatraffic_locators_;
    //! Autogenerated default locators flag
    bool internal_default_locators_;

    //! Encapsulates all associated resources on a Receiving element.
    std::list<ReceiverControlBlock> m_receiverResourcelist;
    //! Receiver resource list needs its own mutext to avoid a race condition.
    std::mutex m_receiverResourcelistMutex;

    //!SenderResource List
    std::timed_mutex m_send_resources_mutex_;
    fastdds::rtps::SendResourceList send_resource_list_;

    //!Participant Listener
    RTPSParticipantListener* mp_participantListener;
    //!Pointer to the user participant
    RTPSParticipant* mp_userParticipant;

    //! Determine if the RTPSParticipantImpl was initialized successfully.
    bool initialized_ = false;

    //! Ignored entities collections
    std::set<GuidPrefix_t> ignored_participants_;
    std::set<GUID_t> ignored_writers_;
    std::set<GUID_t> ignored_readers_;
    //! Protect ignored entities collection concurrent access
    mutable shared_mutex ignored_mtx_;
};
```

#### 域参与者工厂

```c++
class DomainParticipantFactory 
{	
  	// 域 ID -> [DomainParticipantImpl | DomainParticipantImpl| DomainParticipantImpl|]
  	std::map<DomainId_t, std::vector<DomainParticipantImpl*>> participants_;
 		mutable std::mutex mtx_participants_;
  	// 本身 Qos
    DomainParticipantFactoryQos factory_qos_;
    // 域参与者默认 Qos
    DomainParticipantQos default_participant_qos_;
    
    // 话题池
    std::shared_ptr<fastrtps::rtps::detail::TopicPayloadPoolRegistry> topic_pool_;
		
		// 
    std::shared_ptr<fastrtps::rtps::RTPSDomainImpl> rtps_domain_;
};
```
```c++
// RTPS 层的 DomainImpl
class RTPSDomainImpl {
private:
    std::mutex m_mutex;
    typedef std::pair<RTPSParticipant*, RTPSParticipantImpl*> t_p_RTPSParticipant;
    std::vector<t_p_RTPSParticipant> m_RTPSParticipants;
};
```

RTPSDomain
这是一个关联函数类，内部有一系列的 static 函数，但实际调用 `RTPSDomainImpl` 内部函数
```c++
class RTPSDomain
{

};
```


